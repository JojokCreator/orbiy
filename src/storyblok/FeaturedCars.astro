---
import { storyblokEditable } from "@storyblok/astro";
import { getCollection } from "astro:content";
import Button from "../components/reusable/Button.astro";
import FeaturedCarCard from "../components/FeaturedCarCard.astro";

const { blok } = Astro.props;
const { title, header, description, featured_cars_button } = blok;

const showHr = !!header;

// Get all cars from the content collection
const allCars = await getCollection("cars");

// Determine which cars to show initially
let initialLimit = 3;

const featuredCars = allCars.filter((car) => car.data.featured);
const displayCars = featuredCars;
---

<section {...storyblokEditable(blok)} class="site-container vertical-p">
    <div>
        {/* Header */}
        {
            header && (
                <p class="text-blue-gray font-semibold pb-2 md:pb-4">
                    {header}
                </p>
            )
        }

        {/* Conditional HR - only show if header exists */}
        {
            showHr && (
                <hr class="border-t border-blue-gray h-1 w-full pb-6 md:pb-8" />
            )
        }

        <div>
            {/* Title */}
            <Fragment set:html={`<h2 class="text-gray">${title}</h2>`} />

            {/* Description */}
            {description && <p class={`text-gray mt-4`}>{description}</p>}

            <!-- Cars Grid -->
            {
                displayCars.length > 0 && (
                    <div id="cars-container" class="mt-8">
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            {displayCars.slice(0, initialLimit).map((car) => (
                                <div class="car-item">
                                    <FeaturedCarCard car={car} />
                                </div>
                            ))}
                        </div>
                    </div>
                )
            }
            <!-- Footer CTA Button -->
            {
                featured_cars_button && featured_cars_button.length > 0 && (
                    <div class="mt-6 md:mt-12">
                        {
                            <Button
                                type={featured_cars_button[0].style}
                                buttonText={featured_cars_button[0].text}
                                link={featured_cars_button[0].link.cached_url}
                            />
                        }
                    </div>
                )
            }
        </div>
    </div>
</section>
