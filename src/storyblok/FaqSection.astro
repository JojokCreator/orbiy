---
import { storyblokEditable } from "@storyblok/astro";
import { Picture } from "astro:assets";
import Button from "../components/reusable/Button.astro";
import { Icon } from "astro-icon/components";

const { blok } = Astro.props;
const { header, title, image, faqs, button } = blok;
---

<section
  class="relative w-screen overflow-hidden bg-info py-8 md:py-24"
  data-faq-section
  {...storyblokEditable(blok)}
>
  <div class="site-container">
    <p class="text-base-300 font-semibold pb-2 md:pb-4">{header}</p>
    <hr class="border-t border-base-300 h-1 w-full pb-6 md:pb-8" />
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 md:gap-16 items-center">
      <!-- Left side: Header, Title, and Image -->
      <div class="order-2 lg:order-1 space-y-6">
        <div class="text-center lg:text-left">
          <h2 class="text-base-100 max-w-lg">
            {title}
          </h2>
        </div>

        {
          image?.filename && (
            <div class="mt-8 rounded-lg overflow-hidden">
              <Picture
                src={image.filename}
                formats={["avif", "webp"]}
                alt={image.alt || title}
                widths={[400, 600, 800]}
                sizes="(max-width: 640px) 100vw, (max-width: 1024px) 50vw, 400px"
                inferSize={true}
                class="w-full h-auto object-cover rounded-lg max-w-xl"
              />
            </div>
          )
        }
      </div>

      <!-- Right side: FAQ items -->
      <div class="order-1 lg:order-2 p-8 md:p-12 rounded-sm">
        <div class="space-y-4">
          {
            faqs?.map((faq: { question: string; answer: string }, index) => (
              <details
                class="group w-full overflow-hidden border-b border-base-100 transition-all duration-300 ease-in-out hover:cursor-pointer"
                open={index === 0}
              >
                <summary class="relative flex justify-between items-center py-4 md:py-6 mb-4 text-left cursor-pointer hover:bg-gray-900/40 transition-colors rounded px-2 md:px-4 -mx-2">
                  <div class="flex items-start space-x-3 pr-8">
                    <span class="text-base-100 text-base md:text-lg font-medium">
                      0{index + 1}
                    </span>
                    <p class="text-base-100 text-base md:text-lg font-medium">
                      {faq.question}
                    </p>
                  </div>
                  <div class="absolute right-2 top-1/2 transform -translate-y-1/2 group-open:rotate-180 transition-transform duration-300">
                    <Icon
                      name="arrow"
                      class="w-5 h-5 md:w-6 md:h-6 text-base-100"
                    />
                  </div>
                </summary>
                <div class="pb-4 px-2">
                  <p class="text-base-100 font-light text-sm md:text-base opacity-90">
                    {faq.answer}
                  </p>
                </div>
              </details>
            ))
          }
        </div>

        {
          button && (
            <div class="mt-8">
              <Button
                type="filled"
                buttonText={button[0].text}
                link={button[0].url}
              />
            </div>
          )
        }
      </div>
    </div>
  </div>
</section>

<script>
  // Accordion behavior: close other FAQs when one is opened
  const detailsElements = document.querySelectorAll(
    "[data-faq-section] details",
  );

  detailsElements.forEach((details, index) => {
    details.addEventListener("toggle", (e) => {
      if ((e.target as HTMLDetailsElement).open) {
        detailsElements.forEach((otherDetails, otherIndex) => {
          if (otherIndex !== index) {
            (otherDetails as HTMLDetailsElement).open = false;
          }
        });
      }
    });
  });
</script>

<style is:global>
  :root {
    interpolate-size: allow-keywords;
  }

  details::details-content {
    block-size: 0;
    transition:
      block-size 300ms,
      content-visibility 300ms;
    transition-behavior: allow-discrete;
  }

  details[open]::details-content {
    block-size: auto;
  }

  /* Ensure smooth animations */
  details summary {
    list-style: none;
    -webkit-user-select: none;
    user-select: none;
  }

  details summary::-webkit-details-marker {
    display: none;
  }
</style>
