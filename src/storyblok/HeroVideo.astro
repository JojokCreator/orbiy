---
import { storyblokEditable, renderRichText } from "@storyblok/astro";
import { getImage } from "astro:assets";
import Button from "../components/reusable/Button.astro";

const { blok } = Astro.props;
const {
  title,
  description,
  heading,
  background_color,
  button,
  videoSrc,
  videoMobileSrc,
  poster_image,
  poster_image_mobile,
  show_form,
} = blok;

let posterUrl = "";
let posterUrlMobile = "";

if (poster_image?.filename) {
  const { src } = await getImage({
    src: poster_image.filename,
    format: "webp",
    quality: 80,
    width: 1920,
    height: 1080,
  });
  posterUrl = src;
}

if (poster_image_mobile?.filename) {
  const { src } = await getImage({
    src: poster_image_mobile.filename,
    format: "webp",
    quality: 80,
    width: 750,
    height: 1334,
  });
  posterUrlMobile = src;
}

const getBackgroundColorClass = (color: string) => {
  switch (color) {
    case "green":
      return "bg-green";
    case "red":
      return "bg-red";
    default:
      return "bg-black";
  }
};

const backgroundColorClass = getBackgroundColorClass(
  background_color || "black",
);

const HeadingTag = heading || "h1";
---

<section
  class={`relative min-h-[100vh] w-screen overflow-hidden ${backgroundColorClass}`}
  {...storyblokEditable(blok)}
>
  {/* Background image fallback - responsive */}
  {
    posterUrl && (
      <>
        {/* Desktop poster image */}
        <div
          class="absolute inset-0 z-0 hidden sm:block"
          style={`background-image: url('${posterUrl}'); background-size: cover; background-position: center;`}
        />
        {/* Mobile poster image - fallback to desktop if mobile not provided */}
        <div
          class="absolute inset-0 z-0 block sm:hidden"
          style={`background-image: url('${posterUrlMobile || posterUrl}'); background-size: cover; background-position: center;`}
        />
      </>
    )
  }

  {
    videoMobileSrc ? (
      <>
        {/* Desktop video - hidden on mobile when mobile video is provided */}
        <div class="absolute inset-0 z-10 hidden sm:block">
          <video
            class="h-full w-full object-cover opacity-0 transition-opacity duration-1000"
            poster={posterUrl || undefined}
            muted
            autoplay
            loop
            playsinline
            oncanplay="this.classList.add('opacity-100'); this.classList.remove('opacity-0');"
            onerror="this.parentElement.style.display='none';"
          >
            <source src={"/videos/" + videoSrc} type="video/mp4" />
            Your browser does not support the video tag.
          </video>
        </div>

        {/* Mobile video - shown only on mobile when provided */}
        <div class="absolute inset-0 z-10 block sm:hidden">
          <video
            class="h-full w-full object-cover opacity-0 transition-opacity duration-1000"
            poster={posterUrlMobile || posterUrl || undefined}
            muted
            autoplay
            loop
            playsinline
            oncanplay="this.classList.add('opacity-100'); this.classList.remove('opacity-0');"
            onerror="this.parentElement.style.display='none';"
          >
            <source src={"/videos/" + videoMobileSrc} type="video/mp4" />
            Your browser does not support the video tag.
          </video>
        </div>
      </>
    ) : (
      /* Single video for all screens with responsive poster images */
      <>
        {/* Desktop video with desktop poster */}
        <div class="absolute inset-0 z-10 hidden sm:block">
          <video
            class="h-full w-full object-cover opacity-0 transition-opacity duration-1000"
            poster={posterUrl || undefined}
            muted
            autoplay
            loop
            playsinline
            oncanplay="this.classList.add('opacity-100'); this.classList.remove('opacity-0');"
            onerror="this.parentElement.style.display='none';"
          >
            <source src={"/videos/" + videoSrc} type="video/mp4" />
            Your browser does not support the video tag.
          </video>
        </div>
        {/* Same video with mobile poster on mobile */}
        <div class="absolute inset-0 z-10 block sm:hidden">
          <video
            class="h-full w-full object-cover opacity-0 transition-opacity duration-1000"
            poster={posterUrlMobile || posterUrl || undefined}
            muted
            autoplay
            loop
            playsinline
            oncanplay="this.classList.add('opacity-100'); this.classList.remove('opacity-0');"
            onerror="this.parentElement.style.display='none';"
          >
            <source
              src={"/videos/" + videoSrc || "/video.mp4"}
              type="video/mp4"
            />
            Your browser does not support the video tag.
          </video>
        </div>
      </>
    )
  }

  <div class="absolute inset-0 bg-brown/70 z-20"></div>

  <div
    class="relative z-30 flex h-screen md:pt-20 w-full flex-col items-center justify-center px-4 text-center max-w-5xl mx-auto"
  >
    <HeadingTag class="mb-6 text-white text-balance">{title}</HeadingTag>
    <div class="mb-8 text-light-gray max-w-3xl text-balance mx-auto prose prose-invert">
      {renderRichText(description)}
    </div>
    {
      show_form ? (
        <form
          class="w-fit min-w-60 flex flex-col items-start space-y-4 bg-[#4f5450] p-4 lg:p-6 rounded-lg"
          method="POST"
          action="/api/signup"
        >
          <input
            type="text"
            name="fullName"
            placeholder="Full Name"
            required
            class="w-full p-2 text-white placeholder-gray-200 border-b border-white/20 focus:outline-none focus:ring-2 focus:ring-white/50 focus:border-transparent transition-all duration-200"
          />
          <input
            type="email"
            name="email"
            placeholder="Email Address"
            required
            class="w-full p-2 text-white placeholder-gray-200 border-b border-white/20 focus:outline-none focus:ring-2 focus:ring-white/50 focus:border-transparent transition-all duration-200"
          />
          <input
            type="tel"
            name="phone"
            placeholder="Phone Number"
            required
            class="w-full p-2 text-white placeholder-gray-200 border-b border-white/20 focus:outline-none focus:ring-2 focus:ring-white/50 focus:border-transparent transition-all duration-200"
          />
          <button
            type="submit"
            class="bg-green whitespace-nowrap active:focus:animate-click text-[#dedede] relative inline-flex items-center justify-center p-4 px-5 py-3 text-base max-h-12 overflow-hidden rounded-sm transition-all duration-500 ease-in-out hover:bg-dark-green"
          >
            Join The Circle
          </button>
        </form>
      ) : (
        button &&
        button.length > 0 && (
          <Button
            type={button[0].style}
            buttonText={button[0].text}
            link={"/" + button[0].link?.cached_url}
          />
        )
      )
    }
  </div>
</section>
