---
import { Icon } from "astro-icon/components";
import { Picture } from "astro:assets";
import { storyblokEditable } from "@storyblok/astro";

interface Props {
  car: any;
}

const { car } = Astro.props;
const { title, price, description, image, imageAlt, features, link, uuid, id } =
  car;

const featuresList = features
  ? features.split("\n").filter((f: string) => f.trim())
  : [];

// Extract car ID from loopit URL or generate fallback
let assetId;

if (link?.cached_url) {
  const url = link.cached_url;
  const match = url.match(/\/book\/([^?]+)/);
  if (match && match[1]) {
    assetId = match[1];
  }
}

const rentalUrl = `/rental/${assetId}`;

// Always link to our rental page
const linkUrl = rentalUrl;
---

<a href={linkUrl} class="block">
  <div
    {...storyblokEditable(car)}
    class="bg-white/50 border rounded-lg border-gray-200 hover:border-neutral-800 hover:shadow-xs transition-all duration-600 hover:-translate-y-0.5"
  >
    <div class="relative h-fit mb-6 rounded-t-lg overflow-hidden bg-gray-100">
      {
        image?.filename ? (
          <Picture
            src={image.filename}
            formats={["avif", "webp"]}
            inferSize={true}
            alt={imageAlt || title}
            widths={[400, 600, 800]}
            sizes="(max-width: 768px) 100vw, (max-width: 1024px) 50vw, 400px"
            class="w-full h-auto object-cover aspect-video min-h-52"
          />
        ) : (
          <div class="w-full h-full bg-gray-200 flex items-center justify-center aspect-video min-h-52">
            <span class="text-gray-500">Image Coming Soon</span>
          </div>
        )
      }
    </div>
    <div class="space-y-3 p-6">
      <p class="text-xl md:text-2xl font-semibold text-gray line-clamp-1">
        {title}
      </p>
      <p class="text-gray line-clamp-3 my-4">
        {description}
      </p>
      <ul class="space-y-2">
        {
          featuresList.slice(0, 4).map((feature: string) => (
            <li>
              <Icon name="tick" class="inline mr-1.5" />
              {feature}
            </li>
          ))
        }
      </ul>
      <p class="text-2xl md:text-3xl font-medium text-gray py-4">
        <span class="text-base text-gray">From </span>Â£{price}<span
          class="text-base text-gray"
        >
          /per day</span
        >
      </p>
    </div>
  </div>
</a>
